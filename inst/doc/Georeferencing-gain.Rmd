---
title: "Georeferencing data gain"
author: "Igor Ferreira do Nascimento"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: bibli.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Introduction


When you are looking for a new house you investigate the neighborhood environment. It’s happening because the relevant variables associated with the creators of majority people such as safety, infrastructure and pollution rather than being idiosyncratic is at least locally common. Thus, we can considerate that those variables help us to understand the geographic dependency concept.

This situation is an intuitive and practical view of the Waldo Tobler' First Law of Geography "everything is related to everything else, but near things are more related than distant things." @tobler1970computer.

This Vignettes use the geobr package to understand the spatial effect in the Brazilian administrative data analysis. 



## Relação entre taxa de fecundidade e tempo de estudo da população


Nesse exemplo piloto vamos analisar o efeito benéfico da inserção das informações geográficas na modelagem do tempo de estudos em dados municipais do estado de Rondônia (RO) no Brasil disponíveis no [http://atlasbrasil.org.br/2013/pt/download/](Atlas de Desenvolvimento Humano ADH).

O modelo será utilizado para explicar o tempo de estudo em função da taxa de fecundidade total nos municípios quando as variáveis de georefenciamento são incorporadas ao modelo. A figura a seguir apresenta o tempo de estudos e a taxa de fecundidade total.


```{r,  message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
library(spdep)
library(spgwr)
library(RColorBrewer)
library(geobr)
library(readxl)
library(dplyr)
library(ggplot2)


adh <- read_excel("atlas2013_dadosbrutos_pt.xlsx",sheet = "MUN 91-00-10")

adh <- adh %>%
  dplyr::select(ANO,UF,Codmun7,
         E_ANOSESTUDO,FECTOT,
         RAZDEP,IDHM)

adh_2010 <- adh %>%
  filter(ANO==2010)

shape <- read_municipality(cod_muni = "all", year = 2010)

shape_11 <- shape %>%
  filter(substr(code_muni,1,2)=="11") %>%
  left_join(adh_2010,by = c("code_muni"="Codmun7"))


brks <- seq(from = range(shape_11$FECTOT)[1],
            to = range(shape_11$FECTOT)[2],
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=FECTOT)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Fecundity rate",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Fecundity rate in Rondônia-Brazil (2010)")

```

A figura a seguir apresenta o tempo de estudos e a taxa de fecundidade total.


```{r,  message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
library(spdep)
library(spgwr)
library(RColorBrewer)
library(geobr)
library(readxl)
library(dplyr)
library(ggplot2)


adh <- read_excel("C:\\Users\\Igor\\Documents\\geo_add\\atlas2013_dadosbrutos_pt.xlsx",
                  sheet = "MUN 91-00-10")

adh <- adh %>%
  dplyr::select(ANO,UF,Codmun7,
         E_ANOSESTUDO,FECTOT,
         RAZDEP,IDHM)

adh_2010 <- adh %>%
  filter(ANO==2010)

shape <- read_municipality(cod_muni = "all", year = 2010)

shape_11 <- shape %>%
  filter(substr(code_muni,1,2)=="11") %>%
  left_join(adh_2010,by = c("code_muni"="Codmun7"))


brks <- seq(from = range(shape_11$E_ANOSESTUDO)[1],
            to = range(shape_11$E_ANOSESTUDO)[2],
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=E_ANOSESTUDO)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Tempo de estudo",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Tempo de estudo em Rondônia-Brasil (2010)")

```




São ajustados um modelo de regressão via mínimos quadrados ordinários e um outro utilizando o modelo *Geographically Weighted
Regression* (GWR) @spgwr.


O modelo GWR pode ser representado por:

$$y_i = \beta_0(u_i,v_i) + \sum_{j=1}^k \beta_j(u_i,v_i)x_{ij}+\varepsilon_i$$
sendo $y_i$ a variável dependente, $x_{ij}$ as variáveis independentes, $\beta_j$ os coeficientes de regressão específicos no espaço $(u_i,v_i)$ da unidade $i$ e $\varepsilon_i$ o resíduo do modelo. O processo de estimação dos parâmetros do modelo para a unidade $i$ é impactado por outras unidades e a influência e determinada através da matriz de distância $W$ @li2019spatial. Essa influenciada se reduz a medida em que as unidades se distanciam da unidade $i$.

Apesar de existir situações complexas na conceituação e cálculo da distância, ao invés da medida binária de vizinho ou não, é frequentemente utilizado medidas contínuas de distância @gdr. 

Para esse exemplo utilizaremos a distância gaussiana:

$$W(i,j) = e^{{-(d_{i,j}/h)}^2}$$
sendo $d_{i,j}$ a distância euclidiana e $h$ um parâmetro que pode ser determinado por validação cruzada. Os modelos de regressão via OLS e utilizando o GWR podem ser ajustados por meio do seguinte código.


```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
col.bw <- gwr.sel(E_ANOSESTUDO ~ FECTOT, data=as(shape_11, "Spatial"))

gwr_model <- gwr(E_ANOSESTUDO ~ FECTOT, data=as(shape_11, "Spatial"),
                 bandwidth=col.bw, hatmatrix=TRUE)

ols_model <- lm(E_ANOSESTUDO ~ FECTOT, data=shape_11)

shape_11$residuals_ols <- ols_model$residuals
shape_11$residuals_gwr <- gwr_model$SDF$pred-shape_11$E_ANOSESTUDO

model_gwr_data <- gwr_model$SDF@data
model_gwr_data$code_muni <- shape_11$code_muni

model_gwr_data <- model_gwr_data %>% dplyr::select(code_muni,X.Intercept.,FECTOT)
names(model_gwr_data) <- c("code_muni","Intercept","Slope")
shape_11 <- shape_11 %>%
  left_join(model_gwr_data,by = "code_muni")


quantile(shape_11$Slope)
brks <- seq(-2.5,0,by=.5)

ggplot(shape_11) +
  geom_sf(aes(fill=Slope)) +
  scale_fill_gradient(high = "grey90",
                      low= "red", name="Slope",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Slope coefficient")
```



```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

quantile(shape_11$Intercept)
brks <- seq(10,15,by=1)

ggplot(shape_11) +
  geom_sf(aes(fill=Intercept)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Intercept",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Intercept coefficient")

```

De maneira análoga à autocorrelação temporal, a autocorrelação espacial mensura a similaridade de unidades baseado em sua posição espacial, podendo ser exógena ou endógena e calcula, majoritariamente, pelo Índice de Moran @gdr.

Com base no gráfico de qqplot e na estatística de Shapiro-Wilk há evidências
para rejeitar a hipótese de normalidade dos resíduos no modelo OLS. Além disso,
os resíduos analisados apresentam evidências de autocorrelação espacial,
confirmado pelo Índice de Moran. Dessa forma, os resíduos sugerem que o modelo não está
especificado corretamente e que pode haver "informação disperdiçada" ao ignorar as variáveis de posicionamento geográfico.



```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
nb <- poly2nb(as(shape_11, "Spatial"))
lw <- nb2listw(nb)


quantile(shape_11$residuals_ols)
brks <- seq(from = -1.5,
            to = 1.5,
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=residuals_ols)) +
  scale_fill_gradient2(high = "blue", low= "lightcoral", mid = "grey90", name="Residuals",
                      labels = round(brks,2),
                      breaks = brks) +
  labs(title = "Residuals distribuition") +
  labs(title = "OLS residuals")



moran.mc(shape_11$residuals_ols,
         lw, 999)
```

```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

qqnorm(shape_11$residuals_ols,col=2,pch = 20,main = "OLS residuals QQ-Plot")
qqline(shape_11$residuals_ols)
shapiro.test(shape_11$residuals_ols)

```

Por outro lado, quando utilizamos o modelo GWR estamos inserimos as informações espaciais no processo de estimação dos parâmetros do modelo. Como pode ser visto nos gráficos a seguir, não há evidências estatísticas de autocorrelação espacial nos resíduos do modelo GWR. Além disso, não há evidências de violação do pressuposto de normalidade dos resíduos.



```{r,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

quantile(shape_11$residuals_gwr)
brks <- seq(from = -1,
            to = 1,
            length.out =5)


ggplot(shape_11) +
  geom_sf(aes(fill=residuals_gwr)) +
  scale_fill_gradient2(high = "blue", mid= "grey90",low = "lightcoral", name="Residuals",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "GWR residuals")

moran.mc(shape_11$residuals_gwr,
         lw, 999)

```


```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

qqnorm(shape_11$residuals_gwr,col=2,pch = 20,main = "GWR residuals QQ-Plot")
qqline(shape_11$residuals_gwr)
shapiro.test(shape_11$residuals_gwr)

```


## References

