---
title: "Georeferencing data gain"
author: "Igor Ferreira do Nascimento"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: bibli.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Introduction


When you are looking for a new house you investigate the neighborhood environment. It’s happening because the relevant variables associated with the creators of majority people such as safety, infrastructure and pollution rather than being idiosyncratic is at least locally common. Thus, we can considerate that those variables help us to understand the geographic dependency concept.

This situation is an intuitive and practical view of the Waldo Tobler' First Law of Geography "everything is related to everything else, but near things are more related than distant things." @tobler1970computer.

This Vignettes use the geobr package to understand the spatial effect in the Brazilian administrative data analysis. 



## Fertility and years of schooling


There are many studies that associate the years of schooling and fertility. The work of @osili2008does analyse the educational policies in girls and young women and its impact in fertility and GDP.

In our example we analyse the impact on estimates coefficients and model specification in reason add geographical variables in regression model associating eductation level and fertility rate on cities of Rondônia state in Brazil using the package @geobr. The cities data are avaliable in [http://atlasbrasil.org.br/2013/pt/download/](Atlas de Desenvolvimento Humano - ADH).

The model will be used to explain the years of schooling as a function of the fertility rate in the municipalities when the georefining variables are incorporated into the model. The following figure shows the years of schooling and the fertility rate.


```{r,  message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
# devtools::install_github("ipeaGIT/geobr")
library(geobr)

library(spdep)
library(spgwr)
library(RColorBrewer)
library(readxl)
library(dplyr)
library(ggplot2)

adh <- read_excel("C:\\Users\\Igor\\Documents\\geo_add\\atlas2013_dadosbrutos_pt.xlsx",sheet = "MUN 91-00-10")

adh <- adh %>%
  dplyr::select(ANO,UF,Codmun7,
         E_ANOSESTUDO,FECTOT,
         RAZDEP,IDHM)

adh_2010 <- adh %>%
  filter(ANO==2010)

shape <- read_municipality(code_muni = "all", year = 2010)

shape_11 <- shape %>%
  filter(substr(code_muni,1,2)=="11") %>%
  left_join(adh_2010,by = c("code_muni"="Codmun7"))


brks <- seq(from = range(shape_11$FECTOT)[1],
            to = range(shape_11$FECTOT)[2],
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=FECTOT)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Fecundity rate",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Fecundity rate in Rondônia-Brazil (2010)")

```


The following figure shows the years of schooling and the fertility rate.


```{r,  message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}


adh <- read_excel("C:\\Users\\Igor\\Documents\\geo_add\\atlas2013_dadosbrutos_pt.xlsx",
                  sheet = "MUN 91-00-10")

adh <- adh %>%
  dplyr::select(ANO,UF,Codmun7,
         E_ANOSESTUDO,FECTOT,
         RAZDEP,IDHM)

adh_2010 <- adh %>%
  filter(ANO==2010)

shape <- read_municipality(code_muni = 13, year = 2010)

shape_11 <- shape %>%
  left_join(adh_2010,by = c("code_muni"="Codmun7"))


brks <- seq(from = range(shape_11$E_ANOSESTUDO)[1],
            to = range(shape_11$E_ANOSESTUDO)[2],
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=E_ANOSESTUDO)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Years of schooling",
                       labels = round(brks,2),
                       breaks = brks) +
  labs(title = "Education in Rondônia-Brazil (2010)")

```



A regression model is fitted using ordinary least squares and one using the Geographically Weighted Regression  model (GWR) @spgwr

The GWR model can be represented by @li2019spatial:

$$y_i = \beta_0(u_i,v_i) + \sum_{j=1}^k \beta_j(u_i,v_i)x_{ij}+\varepsilon_i$$

where $y_i$ is the dependent variable, $x_ {ij}$ the independent variables, $ \ beta_j $ the regression coefficients in the space $(u_i, v_i)$ of the unit $ i $ and $ \varepsilon_i$ the model's residual. The  model parameters estimating  for unit $ i $ is impacted by other units and the  dependece is determined by distance matrix $W$ @li2019spatial. This influence decreases as units move away from unit $ i $.

Although there are complex situations and approach in the distance calculation, the mostly  distance matrix are continuous measures instead of the binary measure of neighborhood @gdr.

For this example we will use the Gaussian distance:

$$W(i,j) = e^{{-(d_{i,j}/h)}^2}$$
where $d_{i,j}$ is the Euclidean distance and $h$ is the bandwidth parameter that can be determined by cross validation. Regression models via OLS and GWR can be fitted by following code.


```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
bandwidth <- gwr.sel(E_ANOSESTUDO ~ FECTOT, data=as(shape_11, "Spatial"))

gwr_model <- gwr(E_ANOSESTUDO ~ FECTOT, 
                 data=as(shape_11, "Spatial"),
                 bandwidth=bandwidth, 
                 hatmatrix=TRUE)

ols_model <- lm(E_ANOSESTUDO ~ FECTOT, 
                data=shape_11)

shape_11$residuals_ols <- ols_model$residuals
shape_11$residuals_gwr <- gwr_model$SDF$pred-shape_11$E_ANOSESTUDO

model_gwr_data <- gwr_model$SDF@data
model_gwr_data$code_muni <- shape_11$code_muni

model_gwr_data <- model_gwr_data %>% 
  dplyr::select(code_muni,X.Intercept.,FECTOT)
names(model_gwr_data) <- c("code_muni","Intercept","Slope")
shape_11 <- shape_11 %>%
  left_join(model_gwr_data,by = "code_muni")

quantile(shape_11$Slope)
bks <- seq(-2.5,0,by=.5)

ggplot(shape_11) +
  geom_sf(aes(fill=Slope)) +
  scale_fill_gradient(high = "grey90",
                      low= "red", name="Slope",
                       labels = round(bks,2),
                       breaks = bks) +
  labs(title = "Slope coefficient")
```


The slope coefficient show the negative relationship between years of schooling and fertility agreeing to work of @osili2008does.


```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

quantile(shape_11$Intercept)
bks <- seq(10,15,by=1)

ggplot(shape_11) +
  geom_sf(aes(fill=Intercept)) +
  scale_fill_gradient(high = "red",
                      low= "grey90", name="Intercept",
                       labels = round(bks,2),
                       breaks = bks) +
  labs(title = "Intercept coefficient")

```

Similar to temporal autocorrelation, spatial autocorrelation measures the similarity of units based on their spatial position, which may be exogenous or endogenous, and is mostly calculated by the Moran Index @gdr.

Based on the qqplot graph and the Shapiro-Wilk statistic there is evidence
to reject the hypothesis of residual normality in the OLS model. Besides that,
the residues analyzed present evidence of spatial autocorrelation,
confirmed by the Moran Index. Thus, the residuals suggests that the model is not
correctly specified and that there could be "neglected information" due ignored geographic positioning variables.



```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}
nb <- poly2nb(as(shape_11, "Spatial"))
lw <- nb2listw(nb)


quantile(shape_11$residuals_ols)
bks <- seq(from = -1.5,
            to = 1.5,
            length.out =5)

ggplot(shape_11) +
  geom_sf(aes(fill=residuals_ols)) +
  scale_fill_gradient2(high = "blue", low= "lightcoral",
                       mid = "grey90", name="Residuals",
                      labels = round(bks,2),
                      breaks = bks) +
  labs(title = "Residuals distribuition") +
  labs(title = "OLS residuals")



moran.mc(shape_11$residuals_ols,
         lw, 999)
```

```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

qqnorm(shape_11$residuals_ols,col=2,pch = 20,
       main = "OLS residuals QQ-Plot")
qqline(shape_11$residuals_ols)
shapiro.test(shape_11$residuals_ols)

```

whereas that when we use the GWR model the spatial information are inserted in the parameters estimation of model. As show on graphs following , there is no statistical evidence of spatial autocorrelation in the GWR model residuals. In addition, there is no evidence of violation of the normality assumption.


```{r,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

quantile(shape_11$residuals_gwr)
brk <- seq(from = -1,
            to = 1,
            length.out =5)


ggplot(shape_11) +
  geom_sf(aes(fill=residuals_gwr)) +
  scale_fill_gradient2(high = "blue", mid= "grey90",
                       low = "lightcoral", 
                       name="Residuals",
                       labels = round(brk,2),
                       breaks = brks) +
  labs(title = "GWR residuals")

moran.mc(shape_11$residuals_gwr,
         lw, 999)

```


```{r ,message=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

qqnorm(shape_11$residuals_gwr,col=2,pch = 20,
       main = "GWR residuals QQ-Plot")
qqline(shape_11$residuals_gwr)
shapiro.test(shape_11$residuals_gwr)

```


## References

